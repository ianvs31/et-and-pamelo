<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Admin Uploader</title>
    <style>
      body { font-family: -apple-system, system-ui, Segoe UI, Roboto, Helvetica, Arial; margin: 0; background: #fafafa; color: #111; }
      .wrap { max-width: 840px; margin: 0 auto; padding: 20px; }
      h1 { font-size: 20px; margin: 16px 0; }
      .panel { background: white; border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px; }
      .row { display: grid; grid-template-columns: 140px 1fr; gap: 10px; align-items: center; margin: 10px 0; }
      input, select { width: 100%; padding: 10px 12px; border: 1px solid #e5e7eb; border-radius: 10px; font-size: 14px; }
      .btn { padding: 10px 14px; border-radius: 10px; background: #111; color: white; border: 0; cursor: pointer; }
      .hint { color: #6b7280; font-size: 13px; }
      .drop { border: 1px dashed #cbd5e1; border-radius: 12px; padding: 22px; background: #fcfcfd; text-align: center; color: #6b7280; }
      .ok { color: #059669; }
      .err { color: #dc2626; }
      code { background:#f3f4f6; padding: 2px 6px; border-radius: 6px; }
    </style>
  </head>
  <body>
    <div class="wrap">
      <h1>后台上传（写入 GitHub 并触发部署）</h1>
      <div class="panel">
        <div class="row"><label>Admin Secret</label><input id="secret" type="password" placeholder="与 Vercel 的 ADMIN_SECRET 一致"/></div>
        <div class="row"><label>媒体类型</label>
          <select id="type">
            <option value="image">image</option>
            <option value="video">video</option>
            <option value="model">model</option>
          </select>
        </div>
        <div class="row"><label>文件</label>
          <div class="drop" id="drop">拖拽到此或点击选择
            <input id="file" type="file" style="display:none"/>
          </div>
        </div>
        <div class="row"><label>生成的 ID</label><input id="id" placeholder="默认基于文件名生成，可手动修改"/></div>
        <div class="row"><label></label><button class="btn" id="go">上传并写入清单</button></div>
        <p class="hint">说明：本页会将文件（图片/视频/GLB）提交到 GitHub 仓库的 <code>models/</code> 目录，并追加到 <code>models/manifest.json</code>，提交后 Vercel 自动重新部署。</p>
        <div id="msg" class="hint"></div>
      </div>
    </div>
    <script>
      const $ = (s)=>document.querySelector(s);
      const drop = $('#drop'); const input = $('#file'); const msg = $('#msg');
      const idInput = $('#id');
      function nameToId(name){
        return name.toLowerCase().replace(/\.[^.]+$/, '').replace(/\s+/g,'-').replace(/[^a-z0-9-_]/g,'');
      }
      drop.addEventListener('click',()=>input.click());
      drop.addEventListener('dragover',e=>{e.preventDefault(); drop.style.background='#f8fafc';});
      drop.addEventListener('dragleave',()=>{drop.style.background='#fcfcfd';});
      drop.addEventListener('drop',e=>{e.preventDefault(); drop.style.background='#fcfcfd'; const f=e.dataTransfer.files?.[0]; if(f){ input.files=e.dataTransfer.files; idInput.value=nameToId(f.name);} });
      input.addEventListener('change',()=>{const f=input.files?.[0]; if(f){ idInput.value=nameToId(f.name); }});

      async function toBase64(file){
        const buf = await file.arrayBuffer();
        let binary=''; const bytes=new Uint8Array(buf); const n=bytes.byteLength;
        for(let i=0;i<n;i++){ binary += String.fromCharCode(bytes[i]); }
        return btoa(binary);
      }

      $('#go').addEventListener('click', async ()=>{
        msg.textContent='';
        const file = input.files?.[0];
        if(!file){ msg.textContent='请选择文件'; msg.className='err'; return; }
        const id = idInput.value.trim() || nameToId(file.name);
        const type = $('#type').value;
        const secret = $('#secret').value.trim();
        try{
          const contentBase64 = await toBase64(file);
          const ext = file.name.split('.').pop();
          const res = await fetch('/api/upload', { method:'POST', headers:{ 'Content-Type':'application/json', 'x-admin-secret': secret }, body: JSON.stringify({ id, type, filename: file.name, ext, contentBase64 }) });
          const data = await res.json();
          if(!res.ok){ throw new Error(data.error||'上传失败'); }
          msg.textContent = '成功：已提交到 GitHub，等待 Vercel 自动部署。\nCommit: '+(data.commitUrl||'');
          msg.className='ok';
        }catch(err){ msg.textContent='失败：'+err.message; msg.className='err'; }
      });
    </script>
  </body>
  </html>


