<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Admin Uploader</title>
    <style>
      body { font-family: -apple-system, system-ui, Segoe UI, Roboto, Helvetica, Arial; margin: 0; background: #fafafa; color: #111; }
      .wrap { max-width: 840px; margin: 0 auto; padding: 20px; }
      h1 { font-size: 20px; margin: 16px 0; }
      .panel { background: white; border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px; }
      .row { display: grid; grid-template-columns: 140px 1fr; gap: 10px; align-items: center; margin: 10px 0; }
      input, select { width: 100%; padding: 10px 12px; border: 1px solid #e5e7eb; border-radius: 10px; font-size: 14px; }
      .btn { padding: 10px 14px; border-radius: 10px; background: #111; color: white; border: 0; cursor: pointer; }
      .hint { color: #6b7280; font-size: 13px; }
      .drop { border: 1px dashed #cbd5e1; border-radius: 12px; padding: 22px; background: #fcfcfd; text-align: center; color: #6b7280; }
      .ok { color: #059669; }
      .err { color: #dc2626; }
      code { background:#f3f4f6; padding: 2px 6px; border-radius: 6px; }
    </style>
  </head>
  <body>
    <div class="wrap">
      <h1>后台上传（写入 GitHub 并触发部署）</h1>
      <div class="panel">
        <div class="row"><label>Admin Secret</label><input id="secret" type="password" placeholder="与 Vercel 的 ADMIN_SECRET 一致"/></div>
        <div class="row"><label>媒体类型</label>
          <select id="type">
            <option value="image">image</option>
            <option value="video">video</option>
            <option value="model">model</option>
          </select>
        </div>
        <div class="row"><label>文件</label>
          <div class="drop" id="drop">拖拽到此或点击选择
            <input id="file" type="file" style="display:none"/>
          </div>
        </div>
        <div class="row"><label>预览</label>
          <div>
            <img id="upPreview" alt="预览" style="max-width:100%; border-radius:12px; display:none;"/>
          </div>
        </div>
        <div class="row"><label>生成的 ID</label><input id="id" placeholder="默认基于文件名生成，可手动修改"/></div>
        <div class="row"><label></label><button class="btn" id="go">上传并写入清单</button></div>
        <p class="hint">说明：本页会将文件（图片/视频/GLB）提交到 GitHub 仓库的 <code>models/</code> 目录，并追加到 <code>models/manifest.json</code>，提交后 Vercel 自动重新部署。</p>
        <div id="msg" class="hint"></div>
      </div>

      <h1 style="margin-top:24px;">Seedream 图生图（上传宠物照片并生成）</h1>
      <div class="panel">
        <div class="row"><label>提示词</label><input id="sPrompt" placeholder="例如：把我的宠物变成科幻宇航员"/></div>
        <div class="row"><label>模型/Endpoint ID</label><input id="sModel" placeholder="如 doubao-seedream-4-0-250828 或 ep-..."/></div>
        <div class="row"><label>图片</label>
          <div class="drop" id="sDrop">拖拽到此或点击选择
            <input id="sFile" type="file" accept="image/*" style="display:none"/>
          </div>
        </div>
        <div class="row"><label>图片URL</label><input id="sImageUrl" placeholder="可直接粘贴图片直链（优先使用）"/></div>
        <div class="row"><label>输入预览</label>
          <div>
            <img id="sPreview" alt="输入预览" style="max-width:100%; border-radius:12px; display:none;"/>
          </div>
        </div>
        <div class="row"><label>尺寸</label><input id="sSize" placeholder="如 1024x1024 或 2K"/></div>
        <div class="row"><label>质量</label>
          <select id="sQuality">
            <option value="standard">standard</option>
            <option value="hd">hd</option>
          </select>
        </div>
        <div class="row"><label>序列生成</label>
          <select id="sSeq">
            <option value="disabled">disabled</option>
            <option value="enabled">enabled</option>
          </select>
        </div>
        <div class="row"><label>水印</label>
          <select id="sWatermark">
            <option value="true">true</option>
            <option value="false">false</option>
          </select>
        </div>
        <div class="row"><label></label><button class="btn" id="sGo">一键生成</button></div>
        <div id="sMsg" class="hint"></div>
        <div class="row" style="margin-top:12px;">
          <label>结果</label>
          <div>
            <img id="sResult" alt="生成结果" style="max-width:100%; border-radius:12px; display:none;"/>
          </div>
        </div>
      </div>

      <h1 style="margin-top:24px;">图片管理（隐藏 / 删除）</h1>
      <div class="panel">
        <div class="row"><label>操作</label>
          <div>
            <button class="btn" id="mgRefresh">刷新列表</button>
          </div>
        </div>
        <div class="row"><label>列表</label>
          <div id="mgList" class="hint">点击“刷新列表”获取清单</div>
        </div>
        <div id="mgMsg" class="hint"></div>
      </div>
    </div>
    <script>
      const $ = (s)=>document.querySelector(s);
      const drop = $('#drop'); const input = $('#file'); const msg = $('#msg');
      const idInput = $('#id');
      const upPreview = document.querySelector('#upPreview');
      const typeSel = document.querySelector('#type');
      function nameToId(name){
        return name.toLowerCase().replace(/\.[^.]+$/, '').replace(/\s+/g,'-').replace(/[^a-z0-9-_]/g,'');
      }
      drop.addEventListener('click',()=>input.click());
      drop.addEventListener('dragover',e=>{e.preventDefault(); drop.style.background='#f8fafc';});
      drop.addEventListener('dragleave',()=>{drop.style.background='#fcfcfd';});
      drop.addEventListener('drop',async e=>{e.preventDefault(); drop.style.background='#fcfcfd'; const f=e.dataTransfer.files?.[0]; if(f){ input.files=e.dataTransfer.files; idInput.value=nameToId(f.name); await renderUploadPreview(f); }});
      input.addEventListener('change',async()=>{const f=input.files?.[0]; if(f){ idInput.value=nameToId(f.name); await renderUploadPreview(f); }});

      function toggleAccept(){
        if(!input) return;
        const t = typeSel?.value || 'image';
        if(t === 'image') input.setAttribute('accept','image/*'); else input.removeAttribute('accept');
      }
      typeSel?.addEventListener('change', toggleAccept);
      toggleAccept();

      async function toBase64(file){
        const buf = await file.arrayBuffer();
        let binary=''; const bytes=new Uint8Array(buf); const n=bytes.byteLength;
        for(let i=0;i<n;i++){ binary += String.fromCharCode(bytes[i]); }
        return btoa(binary);
      }

      function isImageFile(file){
        if (!file) return false;
        if (file.type && file.type.startsWith('image/')) return true;
        const name = (file.name||'').toLowerCase();
        return /\.(png|jpe?g|webp|gif)$/i.test(name);
      }

      async function renderUploadPreview(file){
        try{
          if(!upPreview) return;
          if(isImageFile(file)){
            const url = URL.createObjectURL(file);
            upPreview.onload = ()=>{ try{ URL.revokeObjectURL(url); } catch{} };
            upPreview.src = url;
            upPreview.style.display = 'block';
          }else{
            upPreview.style.display = 'none';
            upPreview.removeAttribute('src');
          }
        }catch{ /* ignore preview errors */ }
      }

      $('#go').addEventListener('click', async ()=>{
        msg.textContent='';
        const file = input.files?.[0];
        if(!file){ msg.textContent='请选择文件'; msg.className='err'; return; }
        const id = idInput.value.trim() || nameToId(file.name);
        const type = $('#type').value;
        const secret = $('#secret').value.trim();
        try{
          const goBtn = document.querySelector('#go');
          if (goBtn) { goBtn.disabled = true; goBtn.setAttribute('data-old', goBtn.textContent||''); goBtn.textContent='上传中…'; }
          const contentBase64 = await toBase64(file);
          const ext = file.name.split('.').pop();
          const res = await fetch('/api/upload', { method:'POST', headers:{ 'Content-Type':'application/json', 'x-admin-secret': secret }, body: JSON.stringify({ id, type, filename: file.name, ext, contentBase64 }) });
          const text = await res.text();
          let data = null;
          try { data = JSON.parse(text); } catch { /* not json */ }
          if(!res.ok || !data?.ok){ throw new Error(data?.error || text || '上传失败'); }
          const link = data?.src ? ` 可访问路径：${data.src}（部署完成后生效）` : '';
          msg.innerHTML = `成功：已提交到 GitHub，等待 Vercel 自动部署。${link ? `<br/>`+link : ''}${data?.commitUrl ? `<br/>Commit: <a href="${data.commitUrl}" target="_blank" rel="noreferrer">${data.commitUrl}</a>` : ''}`;
          msg.className='ok';
        }catch(err){ msg.textContent='失败：'+err.message; msg.className='err'; }
        finally {
          const goBtn = document.querySelector('#go');
          if (goBtn) { const old=goBtn.getAttribute('data-old')||'上传并写入清单'; goBtn.textContent=old; goBtn.disabled=false; }
        }
      });

      // ==========================
      // Seedream 图生图最小前端
      // ==========================
      const sDrop = document.querySelector('#sDrop');
      const sFile = document.querySelector('#sFile');
      const sPrompt = document.querySelector('#sPrompt');
      const sSize = document.querySelector('#sSize');
      const sQuality = document.querySelector('#sQuality');
      const sGo = document.querySelector('#sGo');
      const sMsg = document.querySelector('#sMsg');
      const sResult = document.querySelector('#sResult');
      const sPreview = document.querySelector('#sPreview');
      const sImageUrl = document.querySelector('#sImageUrl');
      const sModel = document.querySelector('#sModel');
      const sSeq = document.querySelector('#sSeq');
      const sWatermark = document.querySelector('#sWatermark');

      if (sDrop && sFile) {
        sDrop.addEventListener('click', ()=> sFile.click());
        sDrop.addEventListener('dragover', e=>{ e.preventDefault(); sDrop.style.background='#f8fafc'; });
        sDrop.addEventListener('dragleave', ()=>{ sDrop.style.background='#fcfcfd'; });
        sDrop.addEventListener('drop', e=>{ e.preventDefault(); sDrop.style.background='#fcfcfd'; const f=e.dataTransfer.files?.[0]; if(f){ sFile.files=e.dataTransfer.files; renderSeedreamPreview(f); } });
        sFile.addEventListener('change', ()=>{ const f=sFile.files?.[0]; if(f){ renderSeedreamPreview(f); } else { hideSeedreamPreview(); } });
      }

      function fileToDataURL(file){
        return new Promise((resolve, reject)=>{
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.onerror = () => reject(new Error('读取文件失败'));
          reader.readAsDataURL(file);
        });
      }

      function renderSeedreamPreview(file){
        try{
          if(!sPreview) return;
          if(file){
            const url = URL.createObjectURL(file);
            sPreview.onload = ()=>{ try{ URL.revokeObjectURL(url); } catch{} };
            sPreview.src = url;
            sPreview.style.display = 'block';
          }
        }catch{}
      }
      function hideSeedreamPreview(){ if(sPreview){ sPreview.style.display='none'; sPreview.removeAttribute('src'); } }

      if (sGo) {
        sGo.addEventListener('click', async ()=>{
          try{
            sMsg.textContent='';
            sMsg.className='hint';
            sResult.style.display='none';
            const file = sFile?.files?.[0];
            const promptVal = sPrompt?.value?.trim();
            if(!file){ sMsg.textContent='请选择图片'; sMsg.className='err'; return; }
            if(!promptVal){ sMsg.textContent='请输入提示词'; sMsg.className='err'; return; }
            sGo.disabled = true; const oldText = sGo.textContent; sGo.textContent='生成中…';

            const dataUrl = await fileToDataURL(file);
            let finalImage = sImageUrl?.value?.trim() || '';
            if (!finalImage) {
              // 将本地文件临时上传到仓库，换取 URL（需要 Admin Secret）
              const secret = document.querySelector('#secret')?.value?.trim() || '';
              const fname = `seedream-${Date.now()}-${(file.name||'image').replace(/[^a-zA-Z0-9._-]/g,'_')}`;
              const contentBase64 = String(dataUrl).split(',').pop();
              try{
                const up = await fetch('/api/temp-upload', { method:'POST', headers:{ 'Content-Type':'application/json', 'x-admin-secret': secret }, body: JSON.stringify({ filename: fname, contentBase64 }) });
                const ut = await up.text(); let uj=null; try{ uj=JSON.parse(ut); }catch{}
                if(up.ok && uj?.ok && uj?.url){ finalImage = uj.url; }
              }catch{}
              // 回退：若临时上传失败，仍然用 base64 dataURL
              if(!finalImage) finalImage = dataUrl;
            }
            const payload = {
              prompt: promptVal,
              image: finalImage,
              model: sModel?.value?.trim() || undefined,
              size: sSize?.value?.trim() || '1024x1024',
              quality: sQuality?.value || 'standard',
              sequential_image_generation: sSeq?.value || 'disabled',
              watermark: (sWatermark?.value === 'true'),
              response_format: 'url'
            };
            const resp = await fetch('/api/seedream', { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(payload) });
            const text = await resp.text();
            let data=null; try{ data = JSON.parse(text); } catch{}
            if(!resp.ok){
              const errStr = (typeof data?.error==='string') ? data.error : (data?.error?.message || text || '生成失败');
              // 附带上游返回，便于诊断
              throw new Error(errStr + (data?.raw ? (' | raw='+JSON.stringify(data.raw).slice(0,600)) : ''));
            }

            // 兼容返回：data[0].url 或 data[0].b64_json
            let imgUrl = '';
            const item = data?.data?.[0];
            if(item?.url){ imgUrl = item.url; }
            else if(item?.b64_json){ imgUrl = 'data:image/png;base64,' + item.b64_json; }
            if(!imgUrl){ throw new Error('上游无有效结果'); }

            sResult.src = imgUrl;
            sResult.style.display = 'block';
            sMsg.innerHTML = '生成成功' + (item?.url ? `：<a href="${item.url}" target="_blank" rel="noreferrer">打开链接</a>` : '');
            sMsg.className = 'ok';
            sGo.textContent = oldText; sGo.disabled=false;
          }catch(err){
            sMsg.textContent = '失败：' + err.message;
            sMsg.className = 'err';
            sGo.disabled=false; sGo.textContent='一键生成';
          }
        });
      }

      // ==========================
      // 图片管理：列表/隐藏/删除
      // ==========================
      const mgRefresh = document.querySelector('#mgRefresh');
      const mgList = document.querySelector('#mgList');
      const mgMsg = document.querySelector('#mgMsg');

      function htmlescape(s){ return String(s).replace(/[&<>"]|'/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }

      async function mgCall(action, payload){
        const secret = document.querySelector('#secret')?.value?.trim() || '';
        const resp = await fetch('/api/manage', { method:'POST', headers:{ 'Content-Type':'application/json', 'x-admin-secret': secret }, body: JSON.stringify({ action, ...payload }) });
        const text = await resp.text(); let data=null; try{ data = JSON.parse(text); } catch{}
        if(!resp.ok){ throw new Error(data?.error || text || '请求失败'); }
        return data;
      }

      function renderList(items){
        if(!Array.isArray(items) || !items.length){ mgList.innerHTML = '<span class="hint">暂无条目</span>'; return; }
        const rows = items.map((it)=>{
          const badge = it.hidden ? '<span style="color:#dc2626;">隐藏</span>' : '<span style="color:#059669;">显示中</span>';
          const src = htmlescape(it.src || '');
          const id = htmlescape(it.id || '');
          const type = htmlescape(it.type || '');
          return `<div style="display:flex; align-items:center; gap:8px; margin:6px 0;">
            <code>${id}</code>
            <span style="color:#6b7280;">(${type})</span>
            <span>${badge}</span>
            <a href="${src}" target="_blank" rel="noreferrer">预览</a>
            <button class="btn" data-act="${it.hidden? 'unhide':'hide'}" data-id="${id}" style="background:${it.hidden?'#111':'#6b7280'};">${it.hidden? '取消隐藏':'隐藏'}</button>
            <button class="btn" data-act="delete" data-id="${id}" style="background:#b91c1c;">删除</button>
          </div>`;
        }).join('');
        mgList.innerHTML = rows;
        mgList.querySelectorAll('button[data-act]').forEach(btn=>{
          btn.addEventListener('click', async ()=>{
            try{
              mgMsg.textContent=''; mgMsg.className='hint';
              const act = btn.getAttribute('data-act');
              const id = btn.getAttribute('data-id');
              btn.disabled=true; const old=btn.textContent; btn.textContent='处理中…';
              await mgCall(act, { id });
              const { models } = await mgCall('list', {});
              renderList(models);
              btn.textContent=old; btn.disabled=false;
            }catch(err){ mgMsg.textContent='失败：'+err.message; mgMsg.className='err'; }
          });
        });
      }

      if (mgRefresh) {
        mgRefresh.addEventListener('click', async ()=>{
          try{
            mgMsg.textContent=''; mgMsg.className='hint';
            mgList.textContent='加载中…';
            const data = await mgCall('list', {});
            renderList(data.models || []);
          }catch(err){ mgMsg.textContent='失败：'+err.message; mgMsg.className='err'; }
        });
      }
    </script>
  </body>
  </html>


